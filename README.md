## Scope of the Proposal

A standard autogenerated API for firmware’s REST and MQTT interfaces available exposed in Python and Node. 

Generated from existing OpenAPI specification, integration tested against running firmware services to guarantee compatibility and functionality not only on the specification level but on the behaviour level

Integration test coverage of 100% enforced via CI in the autogenerated clients. Breaking changes detected via OASDiff. Changelog autogenerated via OASDiff

Lives in the firmware repo, with the versioning of firmware service, firmware client, and firmware specification locked together via CI. CI forbids manual editing of client

People who want to talk to firmware will simply import this API from the firmware repo and use it.

CI in firmware repository requires that clients be integration tested against firmware and that these tests pass before anything can be merged. 

## The Problem (or: why would this be beneficial?)

Vention firmware is a core part of our technology, but as of today no standardized firmware client exists that consumers can use to access it. 

Thus, each time a repo wants to consume information from the firmware client, they need to create a new client from scratch. Duplicate work. If firmware changes, all of these client implementations need to be updated. Duplicate work.

Additionally, keeping in sync the 
1. Client implementation
2. Firmware documentation
3. Runtime firmware behaviour
4. The versioning of the previous three components

Has proven to be a difficult process to juggle manually. A useful anecdote: during MMAI development, I still remember Doug or Eric flagging me down and telling me something in firmware changed, and to please adapt my client accordingly.

Below is a non exhaustive list of non-theoretical problems we have actually faced

|  | Firmware schema changing but our client was not updated |
| --- | --- |
|  | Firmware schema changed so we have to redo our client |
|  | Confusion about which firmware version we are compatible with |
|  | Schema, client, server drifting out of sync |
|  | People manually editing auto generated client |
|  | Behaviour of server differing from schema |
|  | Have to manually raise alert about and breaking changes |

## The Detailed Solution

My proposal is to create a standard firmware client for HTTP and MQTT that lives in the firmware repository.

### Autogeneration of clients from OpenAPI and Async API

After trying a variety of different generators, I have settled on the following 

- [HeyAPI for Node REST](https://heyapi.dev/) client
- [OpenAPI Python Client](https://github.com/openapi-generators/openapi-python-client) for Python REST client
- The official AsyncAPI generators for MQTT clients in Python and Node

If you want to see the exact commands for generation, I invite you to look at the commands in the [package.json of my exampleAPI](https://github.com/ibrahimt2/exampleAPI/blob/main/package.json) 

### Automatic detection of breaking changes

By leveraging OAS Diff and putting it into our CI, we can prevent breaking from being merged unless the major version is bumped. [You can see an example of this here](https://github.com/ibrahimt2/exampleAPI/pull/11) 

### Create a sync between firmware version, client version and specification version

Via the CI, we will enforce a sync between firmware version, client version and specification version so that questions of wondering which client is compatible with which firmware version, and what a given FW version’s API is are easy to solve. 

[You can see an example of how CI can be used to do this here](https://github.com/ibrahimt2/exampleAPI/blob/main/.github/workflows/ci.yml) (line 94)

### Prevent manual editing of autogenerated clients

Manually editing autogenerated clients destroys regeneratability. In the past, we had no mechanism to prevent it other than PR review, which is fallible. In this client, the CI will fail if anyone manually edits generated code. [Here is an example of how this would function](https://github.com/ibrahimt2/exampleAPI/pull/4)

### 100% integration test client coverage which functions as behavioural validation of firmware as well

Our OpenAPI specification alone cannot catch weird behaviour in firmware. However, if we lock our OpenAPI specification to our client (via autogeneration and forbidding manual editing), and then if we further mandate 100% integration test coverage on the said client, we can validate firmware behaviour. 

So, for example, if I were to describe a method in OpenAPI specification that does not in fact exist on my server, it would be prevented from being commited. [See this as an example](https://github.com/ibrahimt2/exampleAPI/pull/6) 

### Automatic changelog and hosted documentation

We will autogenerate documentation from OpenAPI and AsyncAPI specifications via Redocly, and changelogs via OASDiff

### Proposed Implementation

Essentially what I have described above in the detailed solution. Below you can examine if you want to see the concepts above implemented in code

[https://github.com/ibrahimt2/exampleAPI](https://github.com/ibrahimt2/exampleAPI)
