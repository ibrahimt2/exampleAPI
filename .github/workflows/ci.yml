name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code.
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # Step 2: Set up Python and install Flask server dependencies.
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask requests

      - name: Start Flask Server
        working-directory: ./server
        run: |
          nohup python server.py > ../server.log 2>&1 &
          for i in {1..10}; do
            if curl -s http://localhost:5000/todos > /dev/null; then
              echo "Flask server is up!"
              break
            else
              echo "Waiting for Flask server to start..."
              sleep 3
            fi
          done

      # Step 4: Set up Node.js environment (v18).
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      # Step 5: Install Node dependencies.
      - name: Install Node dependencies
        run: npm install

      - name: Check if generated client is up-to-date
        run: |
          npm run generate-client
          if ! git diff --exit-code ./client; then
            echo "Client is out of date. Please run 'npm run generate-client'."
            exit 1x
          fi

      # Step 6: Run all tests with coverage.
      - name: Run Tests
        run: npm run test

      - name: Run typecheck
        run: npm run build:dev

      - name: Install oasdiff
        run: |
          curl -sSL https://raw.githubusercontent.com/Tufin/oasdiff/main/install.sh | sh

      - name: Compare OpenAPI specs for breaking changes
        run: |
          git show origin/main:spec/server.yaml > old.yaml
          cp spec/server.yaml new.yaml
          oasdiff breaking old.yaml new.yaml -f markdown > openapi-breaking-changes.md || true

      - name: Validate version bump if breaking changes
        run: |
          OLD_VERSION=$(yq '.info.version' old.yaml)
          NEW_VERSION=$(yq '.info.version' new.yaml)
          OLD_MAJOR=$(echo "$OLD_VERSION" | cut -d. -f1)
          NEW_MAJOR=$(echo "$NEW_VERSION" | cut -d. -f1)

          if grep -q "." openapi-breaking-changes.md; then
            echo "ðŸš¨ Breaking changes detected!"
            echo "Old version: $OLD_VERSION"
            echo "New version: $NEW_VERSION"

            if [ "$NEW_MAJOR" -le "$OLD_MAJOR" ]; then
              echo "âŒ Major version must be bumped for breaking changes!"
              cat openapi-breaking-changes.md
              exit 1
            else
              echo "âœ… Breaking changes allowed â€” major version bumped."
            fi
          else
              echo "âœ… No breaking changes detected."
            fi

      - name: Generate OpenAPI changelog
        run: |
          oasdiff changelog old.yaml new.yaml -f markdown > openapi-changelog.md || true

      - name: Append OpenAPI changelog to changelog.md
        run: |
          echo "## ðŸ”„ Changelog ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" >> changelog.md
          cat openapi-changelog.md >> changelog.md
          echo "" >> changelog.md