name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          pip install flask requests

      - name: Start Flask server
        working-directory: ./server
        run: |
          nohup python server.py > ../server.log 2>&1 &
          for i in {1..10}; do
            if curl -s http://localhost:5000/todos > /dev/null; then
              echo "Flask server is up!"
              break
            else
              echo "Waiting for Flask server..."
              sleep 2
            fi
          done

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm ci

      - name: Check if generated client is up to date
        run: |
          npm run generate-client
          if ! git diff --exit-code ./client; then
            echo "Client is out of date. Please run 'npm run generate-client'."
            exit 1
          fi

      - name: Run tests
        run: npm run test

      - name: Run typecheck
        run: npm run build:dev

      # -------- oasdiff logic begins -------- #

      - name: Install oasdiff
        run: |
          curl -sSL https://raw.githubusercontent.com/Tufin/oasdiff/main/install.sh | sh

      - name: Fetch origin/main OpenAPI spec
        run: |
          git fetch origin main
          git show origin/main:spec/server.yaml > old.yaml
          cp spec/server.yaml new.yaml

      - name: Compare OpenAPI specs for breaking changes
        id: breaking
        run: |
          echo "ðŸ” Checking for breaking changes..."
          if ! oasdiff breaking old.yaml new.yaml --fail-on-diff -o openapi-breaking.md -f markdown; then
            echo "has_breaking=true" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "has_breaking=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate version bump if breaking changes
        if: steps.breaking.outputs.has_breaking == 'true'
        run: |
          OLD_VERSION=$(yq '.info.version' old.yaml)
          NEW_VERSION=$(yq '.info.version' new.yaml)
          OLD_MAJOR=$(echo "$OLD_VERSION" | cut -d. -f1)
          NEW_MAJOR=$(echo "$NEW_VERSION" | cut -d. -f1)

          echo "ðŸš¨ Breaking changes detected!"
          echo "Old version: $OLD_VERSION"
          echo "New version: $NEW_VERSION"

          if [ "$NEW_MAJOR" -le "$OLD_MAJOR" ]; then
            echo "âŒ Major version must be bumped for breaking changes!"
            cat openapi-breaking.md
            exit 1
          else
            echo "âœ… Breaking changes allowed â€” major version bumped."
          fi

      - name: Generate changelog
        run: |
          oasdiff changelog old.yaml new.yaml -f markdown -o openapi-changelog.md || true

      - name: Append changelog to changelog.md
        run: |
          echo "## ðŸ”„ Changelog ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" >> changelog.md
          cat openapi-changelog.md >> changelog.md
          echo "" >> changelog.md